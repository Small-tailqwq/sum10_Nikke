<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUM10 GENESIS | Âàõ‰∏ñÁ∫™ÊºîÁÆóÁªàÁ´Ø</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(20, 20, 20, 0.85);
            --grid-bg: #111;
            --accent-gold: #ffd700;
            --accent-cyan: #00f3ff;
            --accent-danger: #ff2a6d;
            --accent-ai: #a29bfe;
            --text-main: #e0e0e0;
            --text-dim: #666;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glow-gold: 0 0 15px rgba(255, 215, 0, 0.3);
            --glow-cyan: 0 0 15px rgba(0, 243, 255, 0.3);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-mono);
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 50% 0%, #1a1a1a 0%, transparent 70%),
                linear-gradient(0deg, transparent 95%, rgba(0, 243, 255, 0.03) 96%, transparent 97%);
            background-size: 100% 100%, 100% 40px;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        /* --- Header --- */
        .header {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            border-bottom: var(--glass-border);
            z-index: 10;
        }
        .brand { display: flex; flex-direction: column; }
        .brand h1 { margin: 0; font-size: 1.4rem; letter-spacing: 4px; color: #fff; text-transform: uppercase; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .brand span { font-size: 0.7rem; color: var(--accent-gold); letter-spacing: 2px; font-weight: bold; }

        .status-panel { display: flex; gap: 30px; }
        .stat-item { text-align: right; }
        .stat-label { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; display: block; margin-bottom: 2px;}
        .stat-value { font-size: 1.5rem; font-weight: 300; color: #fff; line-height: 1; text-shadow: var(--glow-gold); }
        .stat-value.cyan { color: var(--accent-cyan); text-shadow: var(--glow-cyan); }

        /* --- Main Stage --- */
        .stage {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            perspective: 1000px;
            overflow: hidden;
        }

        .grid-frame {
            padding: 10px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid #333;
            border-radius: 4px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            transition: all 0.5s ease;
            backdrop-filter: blur(10px);
        }
        .grid-frame.active { border-color: var(--accent-gold); box-shadow: 0 0 30px rgba(255, 215, 0, 0.15); }
        .grid-frame.hydra-mode { border-color: var(--accent-cyan); box-shadow: 0 0 50px rgba(0, 243, 255, 0.2); }

        .grid-container { display: grid; gap: 2px; }

        .cell {
            width: 40px; height: 40px;
            background: #1a1a1a;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; font-weight: bold; color: #555;
            cursor: pointer; transition: all 0.15s;
            position: relative;
        }
        .cell.active { background: #252525; color: #eee; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05); }
        .cell.placeholder { color: #333; font-family: sans-serif; font-size: 1.5rem; } /* ÂçÅÂ≠óÊû∂Ê†∑Âºè */
        
        .cell.selected { background: #333; color: var(--accent-cyan); border: 1px solid var(--accent-cyan); z-index: 5; } /* ÊªëÂä®ÈÄâ‰∏≠ */

        .cell.matched { background: var(--accent-gold); color: #000; animation: flash 0.4s forwards; z-index: 10; }
        .cell.removed { opacity: 0; pointer-events: none; transform: scale(0.5); }
        
        @keyframes flash { 0% { background: #fff; } 100% { background: var(--accent-gold); transform: scale(0); opacity: 0; } }

        /* --- Dashboard --- */
        .dashboard {
            background: var(--panel-bg);
            border-top: var(--glass-border);
            padding: 20px;
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            gap: 20px;
            backdrop-filter: blur(20px);
            z-index: 20;
        }
        .panel-section { display: flex; flex-direction: column; gap: 10px; }
        .panel-title { font-size: 0.7rem; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 5px; }

        .cali-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .btn-cali {
            background: #111; border: 1px solid #333; color: #888; padding: 8px; font-size: 0.7rem; cursor: pointer; transition: all 0.2s;
            font-family: var(--font-mono); text-transform: uppercase;
        }
        .btn-cali:hover { border-color: #555; color: #fff; }
        .btn-cali.done { border-color: var(--accent-cyan); color: var(--accent-cyan); background: rgba(0, 243, 255, 0.05); }
        .btn-cali.active { border-color: var(--accent-danger); color: var(--accent-danger); animation: pulse 1s infinite; }

        .offset-row { display: flex; gap: 5px; align-items: center; margin-top: 5px; background: #111; padding: 4px; border: 1px solid #333; border-radius: 2px;}
        .offset-label { font-size: 0.7rem; color: #555; padding: 0 5px; }
        .offset-input { background: transparent; border: none; color: var(--accent-gold); width: 100%; text-align: center; font-family: var(--font-mono); font-weight: bold; }
        
        .tactics-box { display: flex; flex-direction: column; justify-content: space-between; height: 100%; gap: 10px; }
        .mode-switch { display: flex; background: #111; border: 1px solid #333; padding: 2px; }
        .mode-opt { flex: 1; text-align: center; padding: 8px; font-size: 0.75rem; color: #555; cursor: pointer; transition: all 0.2s; }
        .mode-opt.selected { background: #222; color: #fff; font-weight: bold; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .mode-opt#opt-god.selected { color: var(--accent-gold); border-bottom: 2px solid var(--accent-gold); }

        .slider-box { display: flex; flex-direction: column; gap: 5px; }
        .slider-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #888; }
        input[type=range] { width: 100%; accent-color: var(--accent-cyan); height: 2px; background: #333; margin-top: 5px;}

        .command-box { display: flex; flex-direction: column; gap: 8px; height: 100%; }
        .btn-main {
            flex: 1; border: none; font-family: var(--font-mono); font-weight: 900; font-size: 1rem; text-transform: uppercase;
            cursor: pointer; transition: all 0.2s; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        /* God Hand states */
        #btn-exec { display: flex; }
        .god-disabled {
            background: #1a1a1a; color: #555; border: 1px solid #333; cursor: not-allowed;
            box-shadow: none;
        }
        .god-armed {
            background: linear-gradient(135deg, #ffb347, #ffd700); color: #000; border: 1px solid rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 18px rgba(255, 215, 0, 0.4);
        }
        .god-hot {
            background: linear-gradient(135deg, #ff2a6d, #ff7b7b); color: #fff; border: 1px solid rgba(255, 42, 109, 0.7);
            box-shadow: 0 0 25px rgba(255, 42, 109, 0.6), 0 0 50px rgba(255, 42, 109, 0.25);
            animation: ripple 1.8s infinite;
        }
        @keyframes ripple {
            0% { box-shadow: 0 0 25px rgba(255,42,109,0.6), 0 0 0 0 rgba(255,42,109,0.25); }
            70% { box-shadow: 0 0 25px rgba(255,42,109,0.6), 0 0 0 25px rgba(255,42,109,0); }
            100% { box-shadow: 0 0 25px rgba(255,42,109,0.6), 0 0 0 35px rgba(255,42,109,0); }
        }
        #btn-run { background: var(--accent-gold); color: #000; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
        #btn-run:hover { background: #ffea00; box-shadow: 0 0 30px rgba(255, 215, 0, 0.4); transform: translateY(-2px); }
        #btn-run:disabled { background: #333; color: #555; box-shadow: none; cursor: not-allowed; transform: none; }

        #btn-exec:hover { filter: brightness(1.05); }
        
        #btn-ai { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: #fff; box-shadow: 0 0 20px rgba(108, 92, 231, 0.3); border: 1px solid rgba(255,255,255,0.1); }
        #btn-ai:hover { filter: brightness(1.2); box-shadow: 0 0 30px rgba(108, 92, 231, 0.5); }

        .btn-sub { background: transparent; border: 1px solid #333; color: #888; padding: 8px; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; flex: 1; }
        .btn-sub:hover { border-color: #666; color: #fff; background: #1a1a1a; }
        .sub-group { display: flex; gap: 5px; }

        .progress-line { position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: #111; z-index: 100; }
        .progress-fill { height: 100%; width: 0%; background: var(--accent-gold); transition: width 0.2s; box-shadow: 0 0 10px var(--accent-gold); }

        /* Toast Notification */
        .toast-container {
            position: fixed; top: 80px; right: -400px; width: 350px;
            background: rgba(10, 10, 15, 0.95); border-left: 4px solid var(--accent-gold);
            padding: 20px; box-shadow: -10px 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px);
            transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 2000;
        }
        .toast-container.show { right: 20px; }
        .toast-title { color: var(--accent-gold); font-size: 0.9rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; display: flex; align-items: center; gap: 10px;}
        .toast-body { color: #ccc; font-size: 0.8rem; line-height: 1.5; }
        .toast-icon { font-size: 1.2rem; }

        /* Modals (unchanged mostly) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        .modal-window { background: #111; border: 1px solid #333; width: 80%; max-width: 800px; height: 70%; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .modal-header { padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .modal-title { color: var(--accent-cyan); font-weight: bold; }
        .modal-body { flex: 1; padding: 0; overflow: hidden; display: flex; flex-direction: column;}
        .log-content, .ai-content { flex: 1; background: #000; padding: 20px; overflow-y: auto; font-size: 0.85rem; line-height: 1.5; }
        .log-content { color: #0f0; font-family: 'Courier New', monospace; white-space: pre-wrap; }
        .ai-content { color: #dcdde1; font-family: 'Segoe UI', sans-serif; }
        .ai-content h1, .ai-content h2 { color: var(--accent-ai); margin-top: 0; }
        textarea.data-input { flex: 1; background: #080808; color: var(--accent-gold); border: none; padding: 20px; font-family: var(--font-mono); resize: none; }

        /* Hydra Logo Overlay */
        .hydra-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none; opacity: 0; transition: opacity 1s;
            font-size: 5rem; color: rgba(0, 243, 255, 0.1); font-weight: 900; letter-spacing: 20px;
            z-index: 0;
        }
        .hydra-overlay.active { opacity: 1; animation: breathe 4s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes breathe { 0%, 100% { opacity: 0.1; transform: scale(1); } 50% { opacity: 0.3; transform: scale(1.05); } }

        @media (max-width: 900px) {
            .dashboard { grid-template-columns: 1fr; grid-template-rows: auto auto auto auto; gap: 15px; height: auto; overflow-y: auto; padding-bottom: 40px;}
            .cali-grid { grid-template-columns: 1fr 1fr 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand">
            <h1>Sum10 Genesis</h1>
            <span>PROJECT HYDRA // V7.1 POLISH</span>
        </div>
        <div class="status-panel">
            <div class="stat-item">
                <span class="stat-label">System Status</span>
                <span id="sys-status" class="stat-value" style="color:#555">OFFLINE</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Clear Rate</span>
                <span id="ui-rate" class="stat-value cyan">0.0%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Score</span>
                <span id="ui-score" class="stat-value">0</span>
            </div>
        </div>
    </div>

    <div class="stage">
        <div class="hydra-overlay" id="hydra-logo">HYDRA</div>
        <div id="grid-frame" class="grid-frame">
            <div id="grid" class="grid-container"></div>
        </div>
    </div>

    <div class="progress-line"><div id="p-bar" class="progress-fill"></div></div>

    <div class="dashboard">
        <!-- Â∑¶‰æßÔºöÊ†°ÂáÜ -->
        <div class="panel-section">
            <div class="panel-title">Calibration Protocol</div>
            <div class="cali-grid">
                <button id="btn-cali-tl" class="btn-cali" onclick="startCalibration('tl')">TL ‚îå</button>
                <button id="btn-cali-tr" class="btn-cali" onclick="startCalibration('tr')">TR ‚îê</button>
                <button id="btn-cali-bl" class="btn-cali" onclick="startCalibration('bl')">BL ‚îî</button>
                <button id="btn-cali-br" class="btn-cali" onclick="startCalibration('br')">BR ‚îò</button>
            </div>
            <div style="display:flex; gap:5px;">
                <button id="btn-cali-apply" class="btn-cali" style="flex:1" disabled onclick="applyCalibration()">Apply</button>
                <button id="btn-cali-test" class="btn-cali" style="flex:1" onclick="testCalibration()">Test Center</button>
            </div>
            <div class="offset-row">
                <span class="offset-label">OFFSET</span>
                <span class="offset-label" style="color:#888">X</span>
                <input id="offset-x" class="offset-input" type="number" value="0" onchange="updateOffset()">
                <span class="offset-label" style="color:#888">Y</span>
                <input id="offset-y" class="offset-input" type="number" value="0" onchange="updateOffset()">
            </div>
        </div>

        <!-- ‰∏≠Èó¥ÔºöÊàòÊúØ -->
        <div class="panel-section">
            <div class="panel-title">Tactical Configuration</div>
            <div class="tactics-box">
                <div class="mode-switch">
                    <div id="opt-classic" class="mode-opt" onclick="setMode('classic')">CLASSIC</div>
                    <div id="opt-omni" class="mode-opt" onclick="setMode('omni')">OMNI</div>
                    <div id="opt-god" class="mode-opt selected" onclick="setMode('god')">GOD (HYDRA)</div>
                </div>
                <div class="slider-box">
                    <div class="slider-row">
                        <span>BEAM WIDTH (Computing Power)</span>
                        <span id="val-width" style="color:var(--accent-cyan)">500</span>
                    </div>
                    <input type="range" id="beam-slider" min="100" max="3000" step="100" value="500" 
                           oninput="document.getElementById('val-width').innerText = this.value">
                    
                    <div class="slider-row" style="margin-top:5px;">
                        <span>HYDRA CORES (Threads)</span>
                        <span id="val-thread" style="color:var(--accent-danger)">8</span>
                    </div>
                    <input type="range" id="thread-slider" min="1" max="32" step="1" value="8" 
                           oninput="document.getElementById('val-thread').innerText = this.value">
                </div>
            </div>
        </div>

        <!-- Âè≥‰æßÔºöÊåá‰ª§ -->
        <div class="panel-section">
            <div class="panel-title">Command Center</div>
            <div class="command-box">
                <button id="btn-ocr" class="btn-main" onclick="triggerOCR()" style="background: linear-gradient(135deg, #00f3ff, #0099cc); color: #000; font-weight: bold;">
                    <span>üì∏ AUTO OCR CAPTURE</span>
                </button>
                <button id="btn-run" class="btn-main" onclick="startSolver()">
                    <span>INITIALIZE</span>
                </button>
                <button id="btn-exec" class="btn-main god-disabled" onclick="onExecClick()" disabled>
                    <span>ENGAGE GOD HAND</span>
                </button>
                <button id="btn-ai" class="btn-main" onclick="askGemini()">
                    <span>‚ú® AI TACTICAL ANALYSIS</span>
                </button>
                <div class="sub-group">
                    <button class="btn-sub" onclick="openEditor()">DATA INPUT</button>
                    <button class="btn-sub" onclick="resetBoard()">RESET</button>
                    <button class="btn-sub" onclick="openLog()">BLACK BOX</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast-container">
        <div class="toast-title"><span class="toast-icon">‚ö†Ô∏è</span> SYSTEM ALERT</div>
        <div class="toast-body" id="toast-msg"></div>
    </div>

    <!-- Modals (Editor, Log, AI) -->
    <div id="editor-modal" class="modal-overlay"><div class="modal-window"><div class="modal-header"><span class="modal-title">DATA INJECTION</span><button class="btn-sub" style="width:auto; padding:2px 10px;" onclick="closeEditor(false)">CLOSE</button></div><div class="modal-body"><textarea id="custom-input" class="data-input" placeholder="Paste matrix data here..."></textarea><div style="padding:15px; display:flex; gap:10px; background:#1a1a1a;"><button class="btn-sub" onclick="generateRandom()">RNG GENERATE</button><button class="btn-cali" style="flex:2; background:var(--accent-cyan); color:#000; border:none; font-weight:bold;" onclick="closeEditor(true)">LOAD DATA</button></div></div></div></div>
    <div id="log-modal" class="modal-overlay"><div class="modal-window"><div class="modal-header"><span class="modal-title">TACTICAL BLACK BOX LOG</span><button class="btn-sub" style="width:auto; padding:2px 10px;" onclick="closeLog()">CLOSE</button></div><div class="modal-body"><div id="log-display" class="log-content">Waiting for telemetry...</div><div style="padding:15px; background:#1a1a1a;"><button class="btn-sub" style="width:100%" onclick="copyLog()">COPY TO CLIPBOARD</button></div></div></div></div>
    <div id="ai-modal" class="modal-overlay"><div class="modal-window" style="border-color: var(--accent-ai);"><div class="modal-header" style="background: rgba(108, 92, 231, 0.1);"><span class="modal-title" style="color:var(--accent-ai)">GEMINI TACTICAL ADVISOR</span><button class="btn-sub" style="width:auto; padding:2px 10px; border-color:var(--accent-ai); color:var(--accent-ai)" onclick="document.getElementById('ai-modal').classList.remove('open')">DISMISS</button></div><div class="modal-body"><div id="ai-output" class="ai-content"><div class="ai-loading">Establishing Neural Link with Gemini...</div></div></div></div></div>

    <script>
        const apiKey = "";
        const GameState = {
            cells: [], rows: 16, cols: 10, score: 0, totalCells: 160,
            isAnimating: false, mode: 'god', socket: null, bestSolution: null,
            isDragging: false, selectionMode: true, // true=select, false=deselect
            execState: 'disabled' // disabled | armed | hot
        };
        
        let RAW_DATA = null; // Start empty for Hydra effect

        // --- Core Logic ---
        function initGame(dataStr) {
            GameState.cells = []; GameState.score = 0; GameState.isAnimating = false;
            
            // --- Reset UI State ---
            const btn = document.getElementById('btn-run');
            btn.innerHTML = "<span>INITIALIZE</span>"; 
            btn.disabled = false;
            setExecState('disabled');
            document.getElementById('p-bar').style.width = '0%';
            document.getElementById('ui-score').innerText = '0';
            document.getElementById('ui-rate').innerText = '0.0%';
            
            // Clear solution
            GameState.bestSolution = null;

            // Default dimensions
            GameState.rows = 16; GameState.cols = 10; GameState.totalCells = 160;

            if (dataStr) {
                const cleanStr = dataStr.replace(/[^0-9]/g, '');
                
                // Â¶ÇÊûúÊòØ160‰ΩçÊï∞Â≠óÔºåËá™Âä®ËØÜÂà´‰∏∫16x10ÁöÑÊ£ãÁõò
                if (cleanStr.length === 160) {
                    GameState.rows = 16;
                    GameState.cols = 10;
                    GameState.totalCells = 160;
                } else {
                    // Âê¶ÂàôÂ∞ùËØï‰ªéÁ¨¨‰∏ÄË°åÊé®Êñ≠ÂàóÊï∞
                    const lines = dataStr.trim().split(/\r?\n/);
                    if (lines.length > 0) {
                        GameState.cols = lines[0].trim().replace(/[^0-9]/g, '').length;
                    }
                    GameState.rows = Math.ceil(cleanStr.length / GameState.cols);
                    GameState.totalCells = cleanStr.length;
                }

                for(let i=0; i<cleanStr.length; i++) {
                    const r = Math.floor(i / GameState.cols);
                    const c = i % GameState.cols;
                    GameState.cells.push({ id: i, val: parseInt(cleanStr[i]), r: r, c: c, active: true });
                }
            } else {
                // Placeholder mode (Crosses)
                for(let i=0; i<GameState.totalCells; i++) {
                    GameState.cells.push({ id: i, val: '‚Ä†', active: false, isPlaceholder: true });
                }
            }

            renderGrid();
            connectBrain();
        }

        function renderGrid() {
            const g = document.getElementById('grid');
            const maxWidth = window.innerWidth * 0.8; 
            const maxHeight = window.innerHeight * 0.6;
            const cellSize = Math.min(40, Math.min(maxWidth / GameState.cols, maxHeight / GameState.rows));
            
            g.style.gridTemplateColumns = `repeat(${GameState.cols}, ${cellSize}px)`;
            g.innerHTML = '';
            
            GameState.cells.forEach(cell => {
                const el = document.createElement('div');
                el.className = cell.isPlaceholder ? 'cell placeholder' : ('cell ' + (cell.active ? 'active' : 'removed'));
                el.style.width = `${cellSize}px`;
                el.style.height = `${cellSize}px`;
                el.id = `c-${cell.id}`;
                el.innerText = cell.val;
                
                // Swipe Event Listeners
                el.onmousedown = (e) => startDrag(e, cell);
                el.onmouseover = (e) => onDrag(e, cell);
                el.onmouseup = endDrag;
                
                g.appendChild(el);
            });
            // Global mouse up to catch drags outside
            document.body.onmouseup = endDrag;
        }

        // --- Swipe Logic ---
        function startDrag(e, cell) {
            if(cell.isPlaceholder || GameState.isAnimating) return;
            GameState.isDragging = true;
            // Toggle selection state based on the first clicked cell
            GameState.selectionMode = !cell.selected; 
            toggleCellSelection(cell, GameState.selectionMode);
        }
        function onDrag(e, cell) {
            if(GameState.isDragging && !cell.isPlaceholder) {
                toggleCellSelection(cell, GameState.selectionMode);
            }
        }
        function endDrag() { GameState.isDragging = false; }
        function toggleCellSelection(cell, select) {
            cell.selected = select;
            const el = document.getElementById(`c-${cell.id}`);
            if(select) el.classList.add('selected');
            else el.classList.remove('selected');
        }

        // --- WebSocket & Brain ---
        function connectBrain() {
            if (GameState.socket && GameState.socket.readyState === WebSocket.OPEN) return;
            GameState.socket = new WebSocket("ws://localhost:8000/ws/optimize");
            
            GameState.socket.onopen = () => {
                document.getElementById('sys-status').innerText = "ONLINE";
                document.getElementById('sys-status').style.color = "var(--accent-gold)";
                // Hydra Effect
                triggerHydraEffect();
            };
            GameState.socket.onclose = () => {
                document.getElementById('sys-status').innerText = "OFFLINE";
                document.getElementById('sys-status').style.color = "#555";
            };
            GameState.socket.onmessage = (e) => handleServerMsg(JSON.parse(e.data));
        }

        function triggerHydraEffect() {
            if (!RAW_DATA) {
                // Fade out crosses
                const cells = document.querySelectorAll('.cell.placeholder');
                cells.forEach((el, idx) => {
                    setTimeout(() => el.style.opacity = 0.1, idx * 5);
                });
                
                // Show Logo
                const logo = document.getElementById('hydra-logo');
                logo.classList.add('active');
                
                // Reset grid to empty after effect
                setTimeout(() => {
                    GameState.cells.forEach(c => { c.val = ''; c.isPlaceholder = false; c.active = false; });
                    renderGrid();
                    // Keep logo breathing
                }, 1500);
            }
        }

        function handleServerMsg(data) {
            if (data.type === 'COUNTDOWN') {
                const btn = document.getElementById(`btn-cali-${data.target}`);
                if(btn) { btn.innerText = data.val; btn.classList.add('active'); }
            }
            else if (data.type === 'POS_CAPTURED') {
                const btn = document.getElementById(`btn-cali-${data.target}`);
                if(btn) { btn.innerText = "OK"; btn.classList.remove('active'); btn.classList.add('done'); }
                checkCaliStatus();
            }
            else if (data.type === 'CALIBRATION_DONE') {
                document.getElementById('grid-frame').classList.add('active');
                document.getElementById('btn-cali-apply').innerText = "CALIBRATED";
                document.getElementById('btn-cali-apply').classList.add('done');
                showToast("SYSTEM CALIBRATED", "Spatial mapping locked. Ready for tactical input.");
            }
            else if (data.type === 'OCR_RESULT') {
                // OCRËØÜÂà´ÁªìÊûúÔºåËá™Âä®Âä†ËΩΩÊ£ãÁõòÊï∞ÊçÆ
                RAW_DATA = data.raw_data;
                initGame(RAW_DATA);
                triggerHydraEffect();
                showToast("OCR COMPLETE", `Board data loaded from screenshot (${data.raw_data.length} digits)`);
            }
            else if (data.type === 'OCR_ERROR') {
                showToast("OCR ERROR", data.msg);
            }
            else if (data.type === 'PROGRESS') {
                document.getElementById('p-bar').style.width = Math.min(95, data.val) + "%";
            }
            else if (data.type === 'BETTER_SOLUTION') {
                // ‰øÆÂ§çÈÄªËæëÔºöÂêéÁ´Ø‰º†ÂõûÁöÑ data.score ÊòØÊ∂àÈô§‰∏™Êï∞
                // ÂàÜÊï∞ = ‰∏™Êï∞ * 1000
                const realScore = data.score * 1000;
                document.getElementById('ui-score').innerText = realScore.toLocaleString();
                GameState.bestSolution = data.path;
                
                // Ê∂àÈô§Áéá = Ê∂àÈô§‰∏™Êï∞ / ÊÄªÊ†ºÂ≠êÊï∞
                let rate = ((data.score / GameState.totalCells) * 100).toFixed(1); 
                document.getElementById('ui-rate').innerText = rate + "%";

                // ÊúâËß£Âç≥ÂèØÂÖÅËÆ∏Â∫îÊÄ•ÊâßË°å
                if (GameState.execState === 'disabled') setExecState('armed');
            }
            else if (data.type === 'DONE') {
                document.getElementById('p-bar').style.width = "100%";
                const btn = document.getElementById('btn-run');
                btn.innerHTML = "<span>REPLAY SIMULATION</span>";
                btn.disabled = false;
                btn.onclick = () => playSolution(GameState.bestSolution);
                setExecState('hot');
                showToast("CALCULATION COMPLETE", "Optimal path generated. God Hand standing by.");
            }
        }

        function checkCaliStatus() {
            const corners = ['tl', 'tr', 'bl', 'br'];
            const allDone = corners.every(c => document.getElementById(`btn-cali-${c}`).classList.contains('done'));
            if(allDone) document.getElementById('btn-cali-apply').disabled = false;
        }

        // --- Toast System ---
        function showToast(title, msg) {
            const t = document.getElementById('toast');
            document.querySelector('.toast-title').innerHTML = `<span class="toast-icon">‚ö†Ô∏è</span> ${title}`;
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 4000);
        }

        // --- Commands ---
        function triggerOCR() {
            if (!GameState.socket || GameState.socket.readyState !== WebSocket.OPEN) {
                showToast("CONNECTION ERROR", "Backend server offline. Please start god_brain.py first.");
                return;
            }
            showToast("OCR INITIATED", "Capturing screenshot in 2 seconds...");
            setTimeout(() => {
                GameState.socket.send(JSON.stringify({cmd: 'RUN_OCR'}));
            }, 2000);
        }

        function startCalibration(target) {
            if(!GameState.socket) return;
            GameState.socket.send(JSON.stringify({ cmd: 'CAPTURE_POS', target: target }));
        }
        function applyCalibration() {
            GameState.socket.send(JSON.stringify({ cmd: 'APPLY_CALIBRATION', rows: GameState.rows, cols: GameState.cols }));
        }
        function updateOffset() {
            const ox = document.getElementById('offset-x').value;
            const oy = document.getElementById('offset-y').value;
            GameState.socket.send(JSON.stringify({ cmd: 'SET_OFFSET', x: ox, y: oy }));
        }
        function testCalibration() {
            GameState.socket.send(JSON.stringify({ cmd: 'TEST_ALIGNMENT' }));
        }

        function startSolver() {
            if(!GameState.socket) { connectBrain(); setTimeout(startSolver, 500); return; }
            if(document.getElementById('btn-run').innerText.includes("REPLAY")) {
                 playSolution(GameState.bestSolution); return;
            }
            if(!RAW_DATA) {
                showToast("NO DATA", "Please input matrix data first.");
                openEditor();
                return;
            }

            const btn = document.getElementById('btn-run');
            btn.innerHTML = "<span>PROCESSING...</span>"; btn.disabled = true;
            setExecState('disabled');

            const payload = {
                cmd: 'START',
                rows: GameState.rows, cols: GameState.cols,
                map: GameState.cells.map(c => c.active ? 1 : 0),
                vals: GameState.cells.map(c => c.val),
                beamWidth: parseInt(document.getElementById('beam-slider').value),
                threads: parseInt(document.getElementById('thread-slider').value),
                mode: GameState.mode
            };
            GameState.socket.send(JSON.stringify(payload));
        }

        let lastExecClick = 0;
        let pendingSingle = null;
        function onExecClick() {
            if (GameState.execState === 'disabled' || !GameState.bestSolution) return;
            const now = Date.now();
            if (now - lastExecClick < 400) {
                if (pendingSingle) { clearTimeout(pendingSingle); pendingSingle = null; }
                lastExecClick = 0;
                executeGodHand(true);
            } else {
                lastExecClick = now;
                pendingSingle = setTimeout(() => {
                    executeGodHand(false);
                    pendingSingle = null;
                }, 380);
            }
        }

        function executeGodHand(isEmergency=false) {
            if(!GameState.bestSolution) return;
            const cdMs = isEmergency ? 1000 : 2000;
            const title = isEmergency ? "EMERGENCY GOD HAND" : "GOD HAND ENGAGED";
            const msg = isEmergency ? "‚ö†Ô∏è Double-tap confirmed. 1s fast deploy." : "‚ö†Ô∏è DO NOT TOUCH MOUSE. 2S COUNTDOWN STARTING.";
            showToast(title, msg);
            setTimeout(() => {
                const cmd = isEmergency ? 'EMERGENCY_EXECUTE' : 'EXECUTE_PATH';
                GameState.socket.send(JSON.stringify({ cmd: cmd, path: GameState.bestSolution }));
            }, cdMs);
        }

        function setExecState(state) {
            const btn = document.getElementById('btn-exec');
            GameState.execState = state;
            btn.classList.remove('god-disabled', 'god-armed', 'god-hot');
            if (state === 'disabled') {
                btn.disabled = true;
                btn.classList.add('god-disabled');
                btn.innerHTML = '<span>ENGAGE GOD HAND</span>';
            } else if (state === 'armed') {
                btn.disabled = false;
                btn.classList.add('god-armed');
                btn.innerHTML = '<span>GOD HAND STANDBY</span>';
            } else if (state === 'hot') {
                btn.disabled = false;
                btn.classList.add('god-hot');
                btn.innerHTML = '<span>GOD HAND READY</span>';
            }
        }

        // --- Helpers ---
        function setMode(mode) {
            GameState.mode = mode;
            document.querySelectorAll('.mode-opt').forEach(el => el.classList.remove('selected'));
            document.getElementById(`opt-${mode}`).classList.add('selected');
        }
        
        function playSolution(path) {
            if(!path) return;
            let i = 0;
            const interval = setInterval(() => {
                if(i >= path.length) { clearInterval(interval); return; }
                const rect = path[i];
                const [r1, c1, r2, c2] = rect;
                for(let r=r1; r<=r2; r++) {
                    for(let c=c1; c<=c2; c++) {
                        const idx = r * GameState.cols + c;
                        const el = document.getElementById(`c-${idx}`);
                        if(el) {
                            el.classList.add('matched');
                            setTimeout(()=>el.classList.remove('matched', 'active', 'removed'), 0); 
                            setTimeout(()=>el.classList.add('removed'), 150);
                        }
                    }
                }
                i++;
            }, 100);
        }

        // --- Modals ---
        function openEditor() { 
            const val = RAW_DATA ? RAW_DATA : "";
            document.getElementById('custom-input').value = val; 
            document.getElementById('editor-modal').classList.add('open'); 
        }
        function closeEditor(save) {
            if (save) {
                const input = document.getElementById('custom-input').value.trim();
                if(input) { 
                    RAW_DATA = input; 
                    initGame(RAW_DATA); 
                    document.getElementById('hydra-logo').classList.remove('active'); // Stop logo if data loaded
                }
            }
            document.getElementById('editor-modal').classList.remove('open');
        }
        function generateRandom() {
            let str = ""; for(let i=0; i<160; i++) str += Math.floor(Math.random()*9 + 1);
            document.getElementById('custom-input').value = str;
        }
        // Force full reset when clicking RESET
        function resetBoard() { 
            initGame(RAW_DATA); 
            // Explicitly force button state even if initGame handles it, just to be safe
            const btn = document.getElementById('btn-run');
            btn.innerHTML = "<span>INITIALIZE</span>";
            btn.onclick = startSolver; // Reset handler just in case
        }
        function clearSelection() {}

        // --- Tactical Log ---
        function openLog() {
            const display = document.getElementById('log-display');
            if (!GameState.bestSolution) {
                display.innerText = ">> NO TACTICAL DATA AVAILABLE.";
            } else {
                let txt = `// SUM10 GENESIS BATTLE REPORT //\n`;
                txt += `MODE: ${GameState.mode.toUpperCase()} | THREADS: ${document.getElementById('thread-slider').value}\n`;
                txt += `------------------------------------------------\n`;
                
                const tempCells = JSON.parse(JSON.stringify(GameState.cells));
                let totalScore = 0;

                GameState.bestSolution.forEach((rect, idx) => {
                    const [r1, c1, r2, c2] = rect;
                    let sum = 0; let vals = [];
                    for(let r=r1; r<=r2; r++) {
                        for(let c=c1; c<=c2; c++) {
                            const cellIdx = r * GameState.cols + c;
                            if(tempCells[cellIdx].active) {
                                sum += tempCells[cellIdx].val;
                                vals.push(tempCells[cellIdx].val);
                                tempCells[cellIdx].active = false;
                            }
                        }
                    }
                    totalScore += vals.length * 1000;
                    txt += `STEP ${String(idx+1).padStart(3,'0')} | [${r1},${c1}]->[${r2},${c2}] | KILL: ${vals.length} | ${vals.join('+')}=${sum}\n`;
                });
                txt += `------------------------------------------------\n`;
                txt += `FINAL SCORE ESTIMATE: ${totalScore}\n`;
                display.innerText = txt;
            }
            document.getElementById('log-modal').classList.add('open');
        }
        function closeLog() { document.getElementById('log-modal').classList.remove('open'); }
        function copyLog() {
            navigator.clipboard.writeText(document.getElementById('log-display').innerText).then(()=>showToast("COPIED","Log extracted to clipboard."));
        }

        // --- Gemini AI ---
        async function askGemini() {
            const modal = document.getElementById('ai-modal');
            const output = document.getElementById('ai-output');
            modal.classList.add('open');
            output.innerHTML = '<div class="ai-loading">Analysing battlefield telemetry...<br>Establishing neural link with Gemini...</div>';

            if (!GameState.bestSolution) {
                output.innerHTML = "<h2>NO DATA</h2><p>Please run the solver first. Gemini needs tactical data to analyze.</p>";
                return;
            }

            const currentScore = document.getElementById('ui-score').innerText;
            const currentRate = document.getElementById('ui-rate').innerText;
            
            const promptText = `
You are the Tactical AI for a high-tech number puzzle game called 'Sum10 Genesis'. 
Current Mission Report:
- Game Mode: ${GameState.mode.toUpperCase()}
- Total Score: ${currentScore}
- Elimination Rate: ${currentRate}
- Total Steps Planned: ${GameState.bestSolution.length}

Please provide a "Battle Report" in a sci-fi, military commander style.
1. Analyze the efficiency based on the Elimination Rate (Low < 60%, Medium 60-85%, High > 85%, Godlike > 95%).
2. Comment on the complexity of the solution.
3. Offer a brief strategic tip for the user (The Player/Commander).
4. Keep it concise, encouraging, and immersive. Use emojis like ‚ú®, üöÄ, üõ°Ô∏è.
`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                output.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            } catch (error) {
                output.innerHTML = `<h2 style="color:var(--accent-danger)">CONNECTION ERROR</h2><p>Failed to reach Gemini Command.</p>`;
            }
        }

        initGame(null); // Init empty
    </script>
</body>
</html>